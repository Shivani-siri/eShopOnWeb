# ASP.NET
# Build and test ASP.NET projects.
# Add steps that publish symbols, save build artifacts, deploy, and more:
# https://docs.microsoft.com/azure/devops/pipelines/apps/aspnet/build-aspnet-4

trigger:
- main  # Trigger the pipeline on pushes to the 'main' branch

pool:
  vmImage: 'windows-latest'

variables:
  buildConfiguration: 'Release'

stages:

# üîç Step 1: SonarCloud Code Analysis
- stage: CodeAnalysis
  displayName: 'SonarCloud Analysis'
  jobs:
    - job: SonarScan
      displayName: 'Run SonarCloud Scan'
      steps:
        - task: UseDotNet@2
          displayName: 'Install .NET 8.0 SDK'
          inputs:
            packageType: 'sdk'
            version: '8.0.x'

        - task: SonarCloudPrepare@1
          inputs:
            SonarCloud: 'SonarCloud-ServiceConnection'  # Must match your service connection name
            organization: 'siripurapushivani'            # Your SonarCloud org key
            scannerMode: 'MSBuild'
            projectKey: 'Skillup-Capstone-Project-Shivani'
            projectName: 'Skillup-Capstone-Project-Shivani'

        - task: DotNetCoreCLI@2
          inputs:
            command: 'build'
            projects: '**/*.sln'
            arguments: '--configuration $(buildConfiguration)'

        - task: SonarCloudAnalyze@1

        - task: SonarCloudPublish@1
          inputs:
            pollingTimeoutSec: '300'

# üöÄ Step 2: Deploy to Pre-Production
- stage: DeployPP
  displayName: 'Deploy to Pre-Production'
  dependsOn: CodeAnalysis
  condition: succeeded()
  jobs:
    - job: Deploy
      displayName: 'Deploy to PP'
      steps:
        - script: echo "Deploying to Pre-Production..."
          displayName: 'Stub: Deployment Script Here'

# üöÄ Step 3: Deploy to Production (optional)
- stage: DeployProd
  displayName: 'Deploy to Production'
  dependsOn: DeployPP
  condition: succeeded()
  jobs:
    - job: Deploy
      displayName: 'Deploy to PROD'
      steps:
        - script: echo "Deploying to Production..."
          displayName: 'Stub: Deployment Script Here'
